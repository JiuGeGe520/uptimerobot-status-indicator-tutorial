<!-- ========== 左下角备案号右侧添加状态监控指示器 ========== -->
<!-- 
  参考 anheyu-app-frontend-main 前端监控实现
  支持四种状态：loading | ok | partial | error
  动态获取 UptimeRobot 监控状态
-->
<style>
/* ========================================
   状态指示器样式（兼容安知鱼主题）
   ======================================== */

/* 容器 */
.uptime-status-indicator {
  display: inline-flex;
  align-items: center;
  margin-left: 0px;
  font-size: 14px;
  text-decoration: none !important;
  cursor: pointer;
  transition: transform 0.2s ease;
}

.uptime-status-indicator:hover {
  transform: scale(1.05);
}

.uptime-status-indicator:hover .status-dot {
  transform: scale(1.2);
}

/* 状态点 */
.uptime-status-indicator .status-dot {
  width: 8px;
  height: 8px;
  border-radius: 50%;
  margin-right: 6px;
  transition: background-color 0.3s, transform 0.2s ease, box-shadow 0.3s;
}

/* 状态文字 */
.uptime-status-indicator .status-text {
  transition: color 0.3s;
}

/* ========== 加载中状态 ========== */
.uptime-status-indicator.status-loading .status-dot {
  background-color: #9ca3af;
  animation: statusPulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
}
.uptime-status-indicator.status-loading .status-text {
  color: #9ca3af;
}

/* ========== 正常状态 ========== */
.uptime-status-indicator.status-ok .status-dot {
  background-color: #10b981;
  box-shadow: 0 0 8px rgba(16, 185, 129, 0.6);
  animation: statusGlow 2s ease-in-out infinite;
}
.uptime-status-indicator.status-ok .status-text {
  color: #10b981;
}
.uptime-status-indicator.status-ok:hover .status-dot {
  box-shadow: 0 0 12px rgba(16, 185, 129, 0.8);
}

/* ========== 部分异常状态 ========== */
.uptime-status-indicator.status-partial .status-dot {
  background-color: #f59e0b;
  box-shadow: 0 0 8px rgba(245, 158, 11, 0.6);
  animation: statusBlink 1.5s ease-in-out infinite;
}
.uptime-status-indicator.status-partial .status-text {
  color: #f59e0b;
}
.uptime-status-indicator.status-partial:hover .status-dot {
  box-shadow: 0 0 12px rgba(245, 158, 11, 0.8);
}

/* ========== 错误状态 ========== */
.uptime-status-indicator.status-error .status-dot {
  background-color: #ef4444;
  box-shadow: 0 0 8px rgba(239, 68, 68, 0.6);
  animation: statusBlink 1s ease-in-out infinite;
}
.uptime-status-indicator.status-error .status-text {
  color: #ef4444;
}
.uptime-status-indicator.status-error:hover .status-dot {
  box-shadow: 0 0 12px rgba(239, 68, 68, 0.8);
}

/* ========== 动画定义 ========== */
/* 正常状态的柔和呼吸动画 */
@keyframes statusGlow {
  0%, 100% {
    box-shadow: 0 0 6px rgba(16, 185, 129, 0.5);
    opacity: 1;
  }
  50% {
    box-shadow: 0 0 10px rgba(16, 185, 129, 0.8);
    opacity: 0.9;
  }
}

/* 加载中的脉冲动画 */
@keyframes statusPulse {
  0%, 100% {
    opacity: 1;
    transform: scale(1);
  }
  50% {
    opacity: 0.5;
    transform: scale(0.9);
  }
}

/* 异常/错误时的闪烁动画 */
@keyframes statusBlink {
  0%, 100% {
    opacity: 1;
  }
  50% {
    opacity: 0.4;
  }
}

/* ========== 暗色模式适配（可选） ========== */
@media (prefers-color-scheme: dark) {
  .uptime-status-indicator.status-loading .status-text {
    color: #6b7280;
  }
}
</style>

<script>
(function () {
  'use strict';

  // ========== 配置项 ==========
  const CONFIG = {
    // 状态页面链接（点击后跳转）
    statusPageUrl: 'https://your-status-page.com/',
    // 状态 API 地址（返回状态数据的 PHP 地址）
    statusApiUrl: 'https://your-domain.com/status_api.php',
    // 轮询间隔（毫秒），5分钟
    pollInterval: 5 * 60 * 1000,
    // 初始插入检测间隔（毫秒）
    insertCheckInterval: 500,
    // ICP 备案号匹配正则
    icpPattern: /[京津沪渝冀豫云辽黑湘皖鲁新苏浙赣鄂桂甘晋蒙陕吉闽贵粤青藏川宁琼]ICP备\d+号?-?\d*/,
    // 备选插入位置选择器（当没有 ICP 备案号时使用）
    fallbackSelectors: [
      { selector: '.record-info', mode: 'append' },      // 备案信息容器内（推荐）
      { selector: '.bar-left', mode: 'createWrapper' },  // 在 .bar-left 内创建包装容器
      { selector: '.footer-bottom-bar .bar-content', mode: 'append' },
      { selector: 'footer', mode: 'append' },
      { selector: '#footer', mode: 'append' }
    ]
  };

  // ========== 状态文字映射 ==========
  const STATUS_TEXT = {
    loading: '状态获取中...',
    ok: '所有业务正常',
    partial: '部分服务异常',
    error: '状态获取失败'
  };

  // ========== 当前状态 ==========
  let currentStatus = 'loading';
  let uptimeElement = null;
  let pollTimer = null;

  // ========== 创建状态指示器元素 ==========
  function createUptimeElement() {
    const uptime = document.createElement('a');
    uptime.href = CONFIG.statusPageUrl;
    uptime.target = '_blank';
    uptime.rel = 'noopener';
    uptime.className = 'uptime-status-indicator status-loading';
    uptime.title = '查看我的项目状态';
    uptime.innerHTML = `
      <span class="status-dot"></span>
      <span class="status-text">${STATUS_TEXT.loading}</span>
    `;
    return uptime;
  }

  // ========== 更新状态显示 ==========
  function updateStatus(status) {
    if (!uptimeElement) return;
    
    currentStatus = status;
    
    // 切换状态类
    uptimeElement.className = 'uptime-status-indicator status-' + status;
    
    // 更新文字
    const textEl = uptimeElement.querySelector('.status-text');
    if (textEl) {
      textEl.textContent = STATUS_TEXT[status] || STATUS_TEXT.error;
    }
  }

  // ========== 获取状态 ==========
  async function fetchStatus() {
    try {
      const response = await fetch(CONFIG.statusApiUrl, {
        method: 'GET',
        headers: {
          'Accept': 'application/json'
        }
      });

      if (!response.ok) {
        console.error('[Uptime Status] API 返回错误:', response.status);
        updateStatus('error');
        return;
      }

      const data = await response.json();
      
      // 根据返回的状态更新显示
      if (data.status === 'ok') {
        updateStatus('ok');
      } else if (data.status === 'partial') {
        updateStatus('partial');
      } else if (data.status === 'error' || data.status === 'down') {
        updateStatus('error');
      } else {
        // 如果返回了监控数据，自行判断状态
        if (data.monitors && Array.isArray(data.monitors)) {
          const hasDown = data.monitors.some(monitor => monitor.status !== 2);
          updateStatus(hasDown ? 'partial' : 'ok');
        } else {
          updateStatus('error');
        }
      }
    } catch (error) {
      console.error('[Uptime Status] 获取状态失败:', error);
      updateStatus('error');
    }
  }

  // ========== 插入状态指示器 ==========
  function insertIndicator() {
    // 防止重复插入
    if (document.querySelector('.uptime-status-indicator')) {
      return true;
    }

    // 方案一：优先查找 ICP 备案号
    const candidates = Array.from(
      document.querySelectorAll('body *')
    ).filter(el => {
      return el.children.length === 0 &&
             CONFIG.icpPattern.test(el.innerText);
    });

    if (candidates.length) {
      const icpTextEl = candidates[candidates.length - 1];
      uptimeElement = createUptimeElement();
      icpTextEl.parentNode.insertBefore(uptimeElement, icpTextEl.nextSibling);
      console.log('[UptimeIndicator] 已插入到 ICP 备案号旁边');
      return true;
    }

    // 方案二：使用备选选择器
    for (const item of CONFIG.fallbackSelectors) {
      const targetEl = document.querySelector(item.selector);
      if (targetEl) {
        uptimeElement = createUptimeElement();
        
        if (item.mode === 'append') {
          // 在元素内部末尾插入
          targetEl.appendChild(uptimeElement);
        } else if (item.mode === 'createWrapper') {
          // 创建包装容器（模拟 .record-info 结构）
          const wrapper = document.createElement('div');
          wrapper.className = 'record-info';
          wrapper.appendChild(uptimeElement);
          targetEl.appendChild(wrapper);
        } else {
          // 在元素后面插入（after）
          targetEl.parentNode.insertBefore(uptimeElement, targetEl.nextSibling);
        }
        
        console.log('[UptimeIndicator] 已插入到备选位置:', item.selector);
        return true;
      }
    }

    return false;
  }

  // ========== 开始轮询状态 ==========
  function startPolling() {
    // 立即获取一次状态
    fetchStatus();
    
    // 设置定时轮询
    if (pollTimer) clearInterval(pollTimer);
    pollTimer = setInterval(fetchStatus, CONFIG.pollInterval);
  }

  // ========== 初始化 ==========
  function init() {
    // 轮询检测是否可以插入元素
    let insertTimer = setInterval(() => {
      if (insertIndicator()) {
        clearInterval(insertTimer);
        // 插入成功后开始轮询状态
        startPolling();
      }
    }, CONFIG.insertCheckInterval);
  }

  // 页面加载完成后初始化
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init);
  } else {
    init();
  }

})();
</script>
