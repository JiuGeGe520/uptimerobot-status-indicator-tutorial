<!--
 * UptimeRobot Status Indicator
 * 
 * 一个轻量级的网站状态监控指示器，通过 UptimeRobot API 实时显示服务状态
 * 
 * @author  九戈戈
 * @blog    https://blog.jiugg.fun/
 * @license MIT
 * 
 * 功能特性：
 * - 四种状态：加载中 / 正常 / 部分异常 / 错误
 * - 精美的 CSS 动画效果（呼吸、脉冲、闪烁）
 * - 自动轮询刷新（默认5分钟）
 * - 自动插入到 ICP 备案号旁边
 * 
 * 使用方法：
 * 1. 部署 status.php 代理到你的服务器
 * 2. 修改下方 CONFIG 配置
 * 3. 将此代码添加到网站 </body> 前
-->

<style>
/* ========================================
   状态指示器样式
   ======================================== */

/* 容器 */
.footer-uptime-link {
  display: inline-flex;
  align-items: center;
  margin-left: 10px;
  font-size: 14px;
  text-decoration: none !important;
  cursor: pointer;
  transition: transform 0.2s ease;
}

.footer-uptime-link:hover {
  transform: scale(1.05);
}

.footer-uptime-link:hover .footer-uptime-dot {
  transform: scale(1.2);
}

/* 状态点 */
.footer-uptime-dot {
  width: 8px;
  height: 8px;
  border-radius: 50%;
  margin-right: 6px;
  transition: background-color 0.3s, transform 0.2s ease, box-shadow 0.3s;
}

/* 状态文字 */
.footer-uptime-text {
  transition: color 0.3s;
}

/* ========================================
   状态样式定义
   ======================================== */

/* 加载中 - 灰色脉冲 */
.footer-uptime-link.status-loading .footer-uptime-dot {
  background-color: #9ca3af;
  animation: statusPulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
}
.footer-uptime-link.status-loading .footer-uptime-text {
  color: #9ca3af;
}

/* 正常 - 绿色呼吸发光 */
.footer-uptime-link.status-ok .footer-uptime-dot {
  background-color: #10b981;
  box-shadow: 0 0 8px rgba(16, 185, 129, 0.6);
  animation: statusGlow 2s ease-in-out infinite;
}
.footer-uptime-link.status-ok .footer-uptime-text {
  color: #10b981;
}
.footer-uptime-link.status-ok:hover .footer-uptime-dot {
  box-shadow: 0 0 12px rgba(16, 185, 129, 0.8);
}

/* 部分异常 - 橙色闪烁 */
.footer-uptime-link.status-partial .footer-uptime-dot {
  background-color: #f59e0b;
  box-shadow: 0 0 8px rgba(245, 158, 11, 0.6);
  animation: statusBlink 1.5s ease-in-out infinite;
}
.footer-uptime-link.status-partial .footer-uptime-text {
  color: #f59e0b;
}
.footer-uptime-link.status-partial:hover .footer-uptime-dot {
  box-shadow: 0 0 12px rgba(245, 158, 11, 0.8);
}

/* 错误 - 红色快速闪烁 */
.footer-uptime-link.status-error .footer-uptime-dot {
  background-color: #ef4444;
  box-shadow: 0 0 8px rgba(239, 68, 68, 0.6);
  animation: statusBlink 1s ease-in-out infinite;
}
.footer-uptime-link.status-error .footer-uptime-text {
  color: #ef4444;
}
.footer-uptime-link.status-error:hover .footer-uptime-dot {
  box-shadow: 0 0 12px rgba(239, 68, 68, 0.8);
}

/* ========================================
   动画定义
   ======================================== */

/* 呼吸发光 - 正常状态 */
@keyframes statusGlow {
  0%, 100% {
    box-shadow: 0 0 6px rgba(16, 185, 129, 0.5);
    opacity: 1;
  }
  50% {
    box-shadow: 0 0 10px rgba(16, 185, 129, 0.8);
    opacity: 0.9;
  }
}

/* 脉冲 - 加载状态 */
@keyframes statusPulse {
  0%, 100% {
    opacity: 1;
    transform: scale(1);
  }
  50% {
    opacity: 0.5;
    transform: scale(0.9);
  }
}

/* 闪烁 - 异常状态 */
@keyframes statusBlink {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.4; }
}
</style>

<script>
(function () {
  'use strict';

  /* ========================================
     配置项 - 请根据实际情况修改
     ======================================== */
  const CONFIG = {
    // 状态页面 URL（点击跳转）
    statusPageUrl: 'https://your-status-page.com/',

    // PHP 代理地址
    proxyUrl: 'https://your-domain.com/status.php',

    // UptimeRobot Read-Only API Key
    // 获取方式：UptimeRobot -> My Settings -> API Settings
    apiKey: 'ur000000-xxxxxxxxxxxxxxxxxxxxxxxx',

    // 轮询间隔（毫秒），默认 5 分钟
    pollInterval: 5 * 60 * 1000,

    // DOM 插入检测间隔（毫秒）
    insertCheckInterval: 500,

    // ICP 备案号匹配正则，用于定位插入位置
    // 示例：/粤ICP备\d+号?-?\d*/ /京ICP备\d+号?-?\d*/
    icpPattern: /[京津沪渝冀豫云辽黑湘皖鲁新苏浙赣鄂桂甘晋蒙陕吉闽贵粤青藏川宁琼]ICP备\d+号?-?\d*/
  };

  /* ========================================
     UptimeRobot 状态码
     ======================================== */
  const STATUS = {
    PAUSED: 0,       // 暂停监控
    NOT_CHECKED: 1,  // 尚未检测
    UP: 2,           // 正常运行
    SEEMS_DOWN: 8,   // 响应异常
    DOWN: 9          // 宕机
  };

  /* ========================================
     状态文字（可自定义）
     ======================================== */
  const STATUS_TEXT = {
    loading: '状态获取中...',
    ok: '所有业务正常',
    partial: '部分服务异常',
    error: '状态获取失败'
  };

  let uptimeElement = null;
  let pollTimer = null;

  /* ========================================
     创建状态指示器 DOM
     ======================================== */
  function createUptimeElement() {
    const el = document.createElement('a');
    el.href = CONFIG.statusPageUrl;
    el.target = '_blank';
    el.rel = 'noopener noreferrer';
    el.className = 'footer-uptime-link status-loading';
    el.title = '查看服务状态';
    el.innerHTML = `
      <span class="footer-uptime-dot"></span>
      <span class="footer-uptime-text">${STATUS_TEXT.loading}</span>
    `;
    return el;
  }

  /* ========================================
     更新状态显示
     ======================================== */
  function updateStatus(status, text) {
    if (!uptimeElement) return;

    // 切换状态类
    uptimeElement.className = 'footer-uptime-link status-' + status;

    // 更新文字
    const textEl = uptimeElement.querySelector('.footer-uptime-text');
    if (textEl) {
      textEl.textContent = text || STATUS_TEXT[status] || STATUS_TEXT.error;
    }
  }

  /* ========================================
     分析监控数据，判断总体状态
     ======================================== */
  function analyzeMonitors(data) {
    const monitors = data.monitors || [];

    if (!monitors.length) {
      return { status: 'error', message: '没有监控数据' };
    }

    let up = 0, down = 0, paused = 0;

    monitors.forEach(m => {
      switch (m.status) {
        case STATUS.PAUSED:
          paused++;
          break;
        case STATUS.UP:
          up++;
          break;
        case STATUS.DOWN:
        case STATUS.SEEMS_DOWN:
          down++;
          break;
      }
    });

    const active = monitors.length - paused;

    // 状态判断逻辑
    if (active === 0) {
      return { status: 'error', message: '没有活跃的监控' };
    }
    if (down === 0) {
      return { status: 'ok', message: STATUS_TEXT.ok };
    }
    if (down < active) {
      return { status: 'partial', message: `部分服务异常 (${down}/${active})` };
    }
    return { status: 'error', message: '所有服务异常' };
  }

  /* ========================================
     请求 API 获取状态
     ======================================== */
  async function fetchStatus() {
    try {
      const response = await fetch(CONFIG.proxyUrl, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          api_key: CONFIG.apiKey,
          format: 'json'
        })
      });

      if (!response.ok) {
        console.error('[UptimeIndicator] HTTP Error:', response.status);
        updateStatus('error');
        return;
      }

      const data = await response.json();

      if (data.stat !== 'ok') {
        console.error('[UptimeIndicator] API Error:', data);
        updateStatus('error');
        return;
      }

      const result = analyzeMonitors(data);
      updateStatus(result.status, result.message);

    } catch (err) {
      console.error('[UptimeIndicator] Fetch Error:', err);
      updateStatus('error');
    }
  }

  /* ========================================
     查找 ICP 备案号并插入指示器
     ======================================== */
  function insertIndicator() {
    // 查找匹配 ICP 备案号的叶子节点
    const candidates = Array.from(document.querySelectorAll('body *'))
      .filter(el => el.children.length === 0 && CONFIG.icpPattern.test(el.innerText));

    if (!candidates.length) return false;

    const icpEl = candidates[candidates.length - 1];

    // 防止重复插入
    if (icpEl.nextSibling?.classList?.contains('footer-uptime-link')) {
      return true;
    }

    uptimeElement = createUptimeElement();
    icpEl.parentNode.insertBefore(uptimeElement, icpEl.nextSibling);
    return true;
  }

  /* ========================================
     启动轮询
     ======================================== */
  function startPolling() {
    fetchStatus();
    if (pollTimer) clearInterval(pollTimer);
    pollTimer = setInterval(fetchStatus, CONFIG.pollInterval);
  }

  /* ========================================
     初始化
     ======================================== */
  function init() {
    const timer = setInterval(() => {
      if (insertIndicator()) {
        clearInterval(timer);
        startPolling();
      }
    }, CONFIG.insertCheckInterval);
  }

  // 等待 DOM 加载完成
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init);
  } else {
    init();
  }

})();
</script>
